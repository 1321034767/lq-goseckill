# 秒杀活动管理功能说明

## 功能概述

在后台管理系统中新增了"秒杀活动管理"功能，管理员可以创建和管理秒杀活动，包括：
- 选择参与秒杀的商品（可多选）
- 设置秒杀的开始和结束时间
- 设置秒杀商品的折扣（0.1-1.0，如0.8表示8折）

## 功能特性

### 1. 创建秒杀活动
- 填写活动名称和描述
- 设置开始时间和结束时间
- 设置折扣（例如：0.8 表示原价的80%，即8折）
- 选择参与秒杀的商品（可多选）
- 为每个商品设置秒杀库存（默认使用商品总库存）

### 2. 查看活动列表
- 显示所有秒杀活动
- 显示活动状态（未开始/进行中/已结束）
- 显示折扣、时间等信息

### 3. 查看活动详情
- 查看活动包含的所有商品
- 显示每个商品的原价和秒杀价
- 显示每个商品的秒杀库存

### 4. 启动活动
- 点击"启动"按钮启动活动
- 自动更新商品状态为"秒杀中"（Status=2）
- 自动同步库存到Redis
- 设置商品的开始和结束时间

### 5. 删除活动
- 删除活动及其关联的商品

## 使用步骤

### 步骤1：创建秒杀活动

1. 登录后台管理系统
2. 点击左侧菜单"秒杀活动管理"
3. 点击"新建活动"按钮
4. 填写活动信息：
   - **活动名称**：例如"双11秒杀活动"
   - **活动描述**：可选，描述活动详情
   - **开始时间**：选择秒杀开始的时间
   - **结束时间**：选择秒杀结束的时间
   - **折扣**：输入0.1-1.0之间的数字，例如0.8表示8折
5. 选择商品：
   - 勾选参与秒杀的商品（可多选）
   - 为每个商品设置秒杀库存（默认使用商品总库存）
6. 点击"保存活动"

### 步骤2：启动活动

1. 在活动列表中，找到要启动的活动
2. 点击"启动"按钮
3. 确认启动（系统会提示）
4. 系统将：
   - 更新商品状态为"秒杀中"
   - 同步库存到Redis
   - 设置商品的秒杀时间

### 步骤3：查看活动详情

1. 在活动列表中，点击"查看"按钮
2. 查看活动包含的所有商品
3. 查看每个商品的秒杀价格和库存

## 数据模型

### SeckillActivity（秒杀活动）
- `ID`: 活动ID
- `Name`: 活动名称
- `Description`: 活动描述
- `StartTime`: 开始时间
- `EndTime`: 结束时间
- `Discount`: 折扣（0.1-1.0）
- `Status`: 状态（0-未开始，1-进行中，2-已结束，3-已取消）

### SeckillActivityProduct（活动商品关联）
- `ID`: 关联ID
- `ActivityID`: 活动ID
- `ProductID`: 商品ID
- `SeckillStock`: 该商品在此活动中的秒杀库存

## API接口

### 1. 获取活动列表
```
GET /api/seckill-activities
```

### 2. 获取活动详情
```
GET /api/seckill-activities/{id}
```

### 3. 创建活动
```
POST /api/seckill-activities
Body: {
  "name": "活动名称",
  "description": "活动描述",
  "start_time": "2024-01-01T10:00:00Z",
  "end_time": "2024-01-01T12:00:00Z",
  "discount": 0.8,
  "product_ids": [1, 2, 3],
  "product_stocks": {1: 10, 2: 20, 3: 30}
}
```

### 4. 更新活动
```
PUT /api/seckill-activities/{id}
Body: {
  "name": "活动名称",
  "description": "活动描述",
  "start_time": "2024-01-01T10:00:00Z",
  "end_time": "2024-01-01T12:00:00Z",
  "discount": 0.8
}
```

### 5. 更新活动商品
```
PUT /api/seckill-activities/{id}/products
Body: {
  "product_ids": [1, 2, 3],
  "product_stocks": {1: 10, 2: 20, 3: 30}
}
```

### 6. 启动活动
```
POST /api/seckill-activities/{id}/start
```

### 7. 删除活动
```
DELETE /api/seckill-activities/{id}
```

## 技术实现

### 后端实现

1. **数据模型**：`internal/datamodels/seckill_activity/seckill_activity.go`
2. **仓储层**：`internal/repository/mysql/seckill_activity_repo.go`
3. **服务层**：`internal/service/seckill_activity_service.go`
4. **API路由**：`internal/server/admin_router.go`

### 前端实现

1. **HTML页面**：`web/admin/index.html`（秒杀活动管理部分）
2. **JavaScript逻辑**：`web/admin/assets/app.js`（秒杀活动管理相关函数）

## 注意事项

1. **折扣设置**：折扣必须在0.1-1.0之间，例如：
   - 0.1 = 1折（原价的10%）
   - 0.5 = 5折（原价的50%）
   - 0.8 = 8折（原价的80%）
   - 1.0 = 原价（不打折）

2. **时间设置**：结束时间必须晚于开始时间

3. **商品选择**：至少需要选择一个商品才能创建活动

4. **库存设置**：秒杀库存不能超过商品总库存

5. **启动活动**：启动活动后，系统会自动：
   - 更新商品状态为"秒杀中"（Status=2）
   - 同步库存到Redis（使用`InitProductStock`方法）
   - 设置商品的开始和结束时间

6. **数据一致性**：启动活动时，如果Redis同步失败，会记录日志但不会阻止活动启动。建议检查Redis连接状态。

## 数据库迁移

系统启动时会自动创建以下表：
- `seckill_activities`：秒杀活动表
- `seckill_activity_products`：活动商品关联表

## 示例场景

### 场景1：创建双11秒杀活动

1. 活动名称：双11秒杀活动
2. 开始时间：2024-11-11 00:00:00
3. 结束时间：2024-11-11 23:59:59
4. 折扣：0.8（8折）
5. 选择商品：商品1、商品2、商品3
6. 设置秒杀库存：商品1=10件，商品2=20件，商品3=30件

### 场景2：启动活动

1. 创建活动后，点击"启动"按钮
2. 系统自动更新商品状态
3. 系统自动同步库存到Redis
4. 用户可以在前台看到秒杀商品并参与秒杀

## 故障排查

### 问题1：启动活动失败

**可能原因**：
- Redis连接失败
- 商品不存在
- 数据库错误

**解决方法**：
- 检查Redis服务是否运行
- 检查商品是否存在
- 查看后台日志

### 问题2：库存未同步到Redis

**可能原因**：
- Redis连接失败
- 商品库存为0

**解决方法**：
- 检查Redis服务状态
- 确保商品有库存
- 手动调用同步接口

### 问题3：前端无法加载活动列表

**可能原因**：
- API接口错误
- 网络问题

**解决方法**：
- 检查浏览器控制台错误
- 检查API接口是否正常
- 检查网络连接

## 后续优化建议

1. **活动状态自动更新**：添加定时任务，自动更新活动状态
2. **活动预览**：添加活动预览功能，查看秒杀价格
3. **批量操作**：支持批量启动/停止活动
4. **活动统计**：显示活动参与人数、成交金额等统计信息
5. **活动模板**：保存常用活动配置为模板，快速创建类似活动
