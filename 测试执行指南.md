# 测试执行指南

## 测试程序已创建

测试程序位于：`cmd/test-seckill-features/main.go`

## 执行测试的步骤

### 1. 启动服务（必须）

```bash
cd /root/internship-preparation/goseckill-12-01

# 启动依赖服务
sudo systemctl start mysql
sudo systemctl start redis-server  
sudo systemctl start rabbitmq-server

# 启动应用服务
nohup go run ./cmd/web > web.log 2>&1 &
nohup go run ./cmd/admin > admin.log 2>&1 &
nohup go run ./cmd/seckill-worker > worker.log 2>&1 &

# 等待服务启动
sleep 5

# 验证服务
curl http://localhost:8080/api/health
curl http://localhost:8081/api/health
```

### 2. 运行测试程序

```bash
cd /root/internship-preparation/goseckill-12-01/cmd/test-seckill-features
go run main.go
```

或者使用测试脚本：

```bash
cd /root/internship-preparation/goseckill-12-01
bash test_all_features.sh
```

## 测试内容

测试程序会验证以下12个功能点：

### ✅ 自动化测试（8项）

1. **秒杀时间校验** - 验证时间范围检查
2. **商品状态校验** - 验证商品状态检查
3. **订单查询接口** - 测试 `/api/orders`
4. **秒杀结果查询接口** - 测试 `/api/seckill/{id}/result`
5. **秒杀库存实时显示** - 测试 `/api/products/{id}/seckill-stock`
6. **监控功能** - 测试 `/api/monitor/stats`
7. **限流功能** - 测试快速请求限流
8. **前端秒杀结果展示** - 提示需要浏览器测试

### ⚠️ 手动测试（4项）

9. **库存自动同步机制** - 需要Admin权限
10. **RabbitMQ消息确认机制** - 需要查看Worker日志
11. **Worker失败时的库存回滚** - 需要模拟失败场景
12. **库存一致性检查** - 需要运行stock-sync服务

## 预期测试结果

```
==========================================
    秒杀功能测试程序
==========================================

【准备阶段】注册/登录用户...
✅ 登录成功，Token: eyJhbGciOiJIUzI1NiIs...

==========================================
    开始功能测试
==========================================

测试: 1. 秒杀时间校验
✅ 1. 秒杀时间校验
   结果: 时间校验生效: seckill not started yet
   耗时: 123ms

测试: 2. 商品状态校验
✅ 2. 商品状态校验
   结果: 状态校验生效: product is not in seckill status
   耗时: 98ms

...

==========================================
    测试报告
==========================================

✅ 1. 秒杀时间校验
   结果: 时间校验生效: seckill not started yet
   耗时: 123ms

...

==========================================
总计: 12 个测试
通过: 10 个
失败: 2 个
通过率: 83.3%
==========================================
```

## 如果服务未启动

如果看到连接错误，请先启动服务：

```bash
# 检查服务状态
ps aux | grep -E "(web|admin|worker)" | grep -v grep

# 如果服务未运行，启动它们
go run ./cmd/web &
go run ./cmd/admin &
go run ./cmd/seckill-worker &
```

## 手动测试详细步骤

请参考：`cmd/test-seckill-features/manual_tests.md`

## 测试文件位置

- 测试程序: `cmd/test-seckill-features/main.go`
- 测试说明: `cmd/test-seckill-features/README.md`
- 手动测试: `cmd/test-seckill-features/manual_tests.md`
- 测试脚本: `test_all_features.sh`
- 快速测试: `quick_test.sh`

## 注意事项

1. **服务依赖**: 确保MySQL、Redis、RabbitMQ都已启动
2. **测试数据**: 确保有测试商品（ID=1，状态=2）
3. **端口占用**: 确保8080和8081端口未被占用
4. **日志查看**: 测试时建议查看服务日志以便排查问题
