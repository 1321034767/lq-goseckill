# 秒杀系统服务器部署指南

## 一、服务器环境准备

### 1.1 系统要求
- 操作系统：Linux (Ubuntu 20.04+ / CentOS 7+)
- Go 版本：1.22 或更高
- 内存：建议 2GB 以上
- 磁盘：建议 10GB 以上可用空间

### 1.2 安装 Go 环境

```bash
# Ubuntu/Debian
wget https://go.dev/dl/go1.22.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# 验证安装
go version
```

## 二、安装依赖服务

### 2.1 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server -y

# CentOS/RHEL
sudo yum install mysql-server -y
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 配置 MySQL
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p << EOF
CREATE DATABASE goseckill CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'goseckill'@'localhost' IDENTIFIED BY 'goseckill123';
GRANT ALL PRIVILEGES ON goseckill.* TO 'goseckill'@'localhost';
FLUSH PRIVILEGES;
EOF
```

### 2.2 安装 Redis

```bash
# Ubuntu/Debian
sudo apt install redis-server -y

# CentOS/RHEL
sudo yum install epel-release -y
sudo yum install redis -y

# 启动并设置开机自启
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证
redis-cli ping  # 应返回 PONG
```

### 2.3 安装 RabbitMQ

```bash
# Ubuntu/Debian
sudo apt install rabbitmq-server -y

# CentOS/RHEL
sudo yum install rabbitmq-server -y

# 启动并设置开机自启
sudo systemctl start rabbitmq-server
sudo systemctl enable rabbitmq-server

# 启用管理插件（可选）
sudo rabbitmq-plugins enable rabbitmq_management

# 创建用户（可选，默认 guest/guest）
sudo rabbitmqctl add_user admin admin123
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

## 三、部署项目

### 3.1 上传项目到服务器

**重要提示：**
- 标记为 `[本地]` 的命令在**你的本地电脑**上执行
- 标记为 `[服务器]` 的命令在**服务器**上执行（需要先 SSH 登录）

```bash
# 方式1：使用 git（如果项目在 git 仓库）
# [服务器] 在服务器上执行
cd /opt
git clone <your-repo-url> goseckill
cd goseckill

# 方式2：使用 scp 上传（推荐）
# [本地] 在你的本地电脑上执行，将项目上传到服务器
# 注意：将 your-server-ip 替换为你的服务器IP地址
scp -r goseckill-12-01 root@your-server-ip:/opt/

# 方式3：使用 rsync
# [本地] 在你的本地电脑上执行
rsync -avz goseckill-12-01 root@your-server-ip:/opt/
```

### 3.2 安装项目依赖

```bash
# [服务器] 以下命令在服务器上执行（需要先 SSH 登录）
cd /opt/goseckill-12-01
go mod download
go mod tidy
```

### 3.3 配置项目

项目使用默认配置，如需修改，可以编辑 `internal/config/config.go` 中的 `DefaultConfig()` 函数，或创建配置文件。

**默认配置：**
- Web 服务：`0.0.0.0:8080`
- Admin 服务：`0.0.0.0:8081`
- MySQL：`goseckill:goseckill123@tcp(127.0.0.1:3306)/goseckill`
- Redis：`127.0.0.1:6379`
- RabbitMQ：`amqp://guest:guest@127.0.0.1:5672/`

**如需修改配置，可以：**
1. 修改 `internal/config/config.go` 中的默认值
2. 或设置环境变量（需要修改代码支持环境变量读取）

### 3.4 编译项目

```bash
# [服务器] 以下命令在服务器上执行
# 编译 Web 服务
go build -o bin/web ./cmd/web

# 编译 Admin 服务
go build -o bin/admin ./cmd/admin

# 编译 Worker 服务
go build -o bin/seckill-worker ./cmd/seckill-worker
```

## 四、启动服务

### 4.1 手动启动（测试用）

```bash
# 启动依赖服务
sudo systemctl start mysql
sudo systemctl start redis-server
sudo systemctl start rabbitmq-server

# 启动 Web 服务（前台运行，用于测试）
./bin/web

# 启动 Admin 服务（新终端）
./bin/admin

# 启动 Worker 服务（新终端）
./bin/seckill-worker
```

### 4.2 使用 systemd 管理服务（推荐）

#### 创建 Web 服务 systemd 文件

```bash
sudo nano /etc/systemd/system/goseckill-web.service
```

内容如下：

```ini
[Unit]
Description=GoSeckill Web Service
After=network.target mysql.service redis-server.service rabbitmq-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/goseckill-12-01
ExecStart=/opt/goseckill-12-01/bin/web
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

#### 创建 Admin 服务 systemd 文件

```bash
sudo nano /etc/systemd/system/goseckill-admin.service
```

内容如下：

```ini
[Unit]
Description=GoSeckill Admin Service
After=network.target mysql.service redis-server.service rabbitmq-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/goseckill-12-01
ExecStart=/opt/goseckill-12-01/bin/admin
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

#### 创建 Worker 服务 systemd 文件

```bash
sudo nano /etc/systemd/system/goseckill-worker.service
```

内容如下：

```ini
[Unit]
Description=GoSeckill Worker Service
After=network.target mysql.service redis-server.service rabbitmq-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/goseckill-12-01
ExecStart=/opt/goseckill-12-01/bin/seckill-worker
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

#### 启动和管理服务

```bash
# 重新加载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start goseckill-web
sudo systemctl start goseckill-admin
sudo systemctl start goseckill-worker

# 设置开机自启
sudo systemctl enable goseckill-web
sudo systemctl enable goseckill-admin
sudo systemctl enable goseckill-worker

# 查看服务状态
sudo systemctl status goseckill-web
sudo systemctl status goseckill-admin
sudo systemctl status goseckill-worker

# 查看日志
sudo journalctl -u goseckill-web -f
sudo journalctl -u goseckill-admin -f
sudo journalctl -u goseckill-worker -f

# 停止服务
sudo systemctl stop goseckill-web
sudo systemctl stop goseckill-admin
sudo systemctl stop goseckill-worker

# 重启服务
sudo systemctl restart goseckill-web
sudo systemctl restart goseckill-admin
sudo systemctl restart goseckill-worker
```

### 4.3 使用 Supervisor 管理服务（备选方案）

如果不想使用 systemd，可以使用 Supervisor：

```bash
# 安装 Supervisor
sudo apt install supervisor -y  # Ubuntu/Debian
# 或
sudo yum install supervisor -y  # CentOS/RHEL

# 创建配置文件
sudo nano /etc/supervisor/conf.d/goseckill.conf
```

内容如下：

```ini
[program:goseckill-web]
command=/opt/goseckill-12-01/bin/web
directory=/opt/goseckill-12-01
autostart=true
autorestart=true
stderr_logfile=/var/log/goseckill-web.err.log
stdout_logfile=/var/log/goseckill-web.out.log
user=root

[program:goseckill-admin]
command=/opt/goseckill-12-01/bin/admin
directory=/opt/goseckill-12-01
autostart=true
autorestart=true
stderr_logfile=/var/log/goseckill-admin.err.log
stdout_logfile=/var/log/goseckill-admin.out.log
user=root

[program:goseckill-worker]
command=/opt/goseckill-12-01/bin/seckill-worker
directory=/opt/goseckill-12-01
autostart=true
autorestart=true
stderr_logfile=/var/log/goseckill-worker.err.log
stdout_logfile=/var/log/goseckill-worker.out.log
user=root
```

```bash
# 重新加载配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start goseckill-web
sudo supervisorctl start goseckill-admin
sudo supervisorctl start goseckill-worker

# 查看状态
sudo supervisorctl status

# 查看日志
sudo tail -f /var/log/goseckill-web.out.log
```

## 五、防火墙配置

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 8080/tcp  # Web 服务
sudo ufw allow 8081/tcp  # Admin 服务

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --permanent --add-port=8081/tcp
sudo firewall-cmd --reload

# 或使用 iptables
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8081 -j ACCEPT
```

## 六、使用 Nginx 反向代理（可选但推荐）

### 6.1 安装 Nginx

```bash
sudo apt install nginx -y  # Ubuntu/Debian
sudo yum install nginx -y  # CentOS/RHEL
```

### 6.2 配置 Nginx

```bash
sudo nano /etc/nginx/sites-available/goseckill
```

内容如下：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或 IP

    # Web 前端
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 接口
    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Admin 后台（可选，建议限制访问）
    location /admin {
        proxy_pass http://127.0.0.1:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/goseckill /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

## 七、验证部署

### 7.1 检查服务状态

```bash
# 检查所有服务
sudo systemctl status goseckill-web
sudo systemctl status goseckill-admin
sudo systemctl status goseckill-worker
sudo systemctl status mysql
sudo systemctl status redis-server
sudo systemctl status rabbitmq-server
```

### 7.2 测试接口

```bash
# 健康检查
curl http://localhost:8080/api/health

# 查看商品列表
curl http://localhost:8080/api/products

# 如果配置了 Nginx
curl http://your-domain.com/api/health
```

### 7.3 访问前端

在浏览器中访问：
- Web 前端：`http://your-server-ip:8080` 或 `http://your-domain.com`
- Admin 后台：`http://your-server-ip:8081` 或 `http://your-domain.com/admin`

## 八、常见问题排查

### 8.1 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u goseckill-web -n 50
sudo journalctl -u goseckill-admin -n 50
sudo journalctl -u goseckill-worker -n 50

# 检查端口占用
sudo netstat -tlnp | grep 8080
sudo netstat -tlnp | grep 8081
```

### 8.2 数据库连接失败

```bash
# 检查 MySQL 是否运行
sudo systemctl status mysql

# 测试连接
mysql -u goseckill -p -h 127.0.0.1 goseckill

# 检查数据库是否存在
mysql -u root -p -e "SHOW DATABASES;"
```

### 8.3 Redis 连接失败

```bash
# 检查 Redis 是否运行
sudo systemctl status redis-server

# 测试连接
redis-cli ping
```

### 8.4 RabbitMQ 连接失败

```bash
# 检查 RabbitMQ 是否运行
sudo systemctl status rabbitmq-server

# 查看队列
sudo rabbitmqctl list_queues
```

## 九、更新部署

当代码更新后：

```bash
cd /opt/goseckill-12-01

# 拉取最新代码（如果使用 git）
git pull

# 或重新上传文件

# 重新编译
go build -o bin/web ./cmd/web
go build -o bin/admin ./cmd/admin
go build -o bin/seckill-worker ./cmd/seckill-worker

# 重启服务
sudo systemctl restart goseckill-web
sudo systemctl restart goseckill-admin
sudo systemctl restart goseckill-worker
```

## 十、备份建议

### 10.1 数据库备份

```bash
# 创建备份脚本
sudo nano /opt/backup-db.sh
```

内容：

```bash
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
mysqldump -u goseckill -pgoseckill123 goseckill > $BACKUP_DIR/goseckill_$DATE.sql
# 保留最近7天的备份
find $BACKUP_DIR -name "goseckill_*.sql" -mtime +7 -delete
```

```bash
chmod +x /opt/backup-db.sh

# 添加到 crontab（每天凌晨2点备份）
crontab -e
# 添加：0 2 * * * /opt/backup-db.sh
```

## 十一、性能优化建议

1. **数据库优化**：添加索引，优化查询
2. **Redis 优化**：配置持久化，设置合适的内存限制
3. **RabbitMQ 优化**：配置队列持久化，设置合适的预取数量
4. **应用优化**：使用连接池，优化并发处理
5. **负载均衡**：多实例部署，使用 Nginx 负载均衡

---

**部署完成后，记得：**
- 修改默认密码（MySQL、RabbitMQ）
- 配置 SSL 证书（生产环境）
- 设置监控和告警
- 定期备份数据
