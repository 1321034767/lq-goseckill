# 测试程序使用说明

## 概述

已创建完整的测试程序来验证12个功能点的实现情况。

## 文件结构

```
cmd/test-seckill-features/
├── main.go              # 主测试程序
├── README.md            # 测试说明文档
└── manual_tests.md      # 手动测试指南

test_all_features.sh     # 一键测试脚本
```

## 快速开始

### 方式1: 使用测试脚本（推荐）

```bash
bash test_all_features.sh
```

### 方式2: 直接运行测试程序

```bash
cd cmd/test-seckill-features
go run main.go
```

## 测试内容

### 自动化测试（8项）

以下测试可以自动完成：

1. ✅ **秒杀时间校验** - 自动检测时间校验是否生效
2. ✅ **商品状态校验** - 自动检测状态校验是否生效
3. ✅ **订单查询接口** - 测试 `/api/orders` 接口
4. ✅ **秒杀结果查询接口** - 测试 `/api/seckill/{id}/result` 接口
5. ✅ **秒杀库存实时显示** - 测试 `/api/products/{id}/seckill-stock` 接口
6. ✅ **监控功能** - 测试 `/api/monitor/stats` 接口
7. ✅ **限流功能** - 快速发送请求测试限流
8. ✅ **前端秒杀结果展示** - 提示需要浏览器测试

### 手动测试（4项）

以下测试需要手动验证，详细步骤见 `cmd/test-seckill-features/manual_tests.md`：

1. ⚠️ **库存自动同步机制** - 需要管理员权限
2. ⚠️ **RabbitMQ消息确认机制** - 需要查看Worker日志
3. ⚠️ **Worker失败时的库存回滚** - 需要模拟失败场景
4. ⚠️ **库存一致性检查** - 需要运行stock-sync服务

## 测试前准备

### 1. 启动服务

```bash
# 启动依赖服务
sudo systemctl start mysql
sudo systemctl start redis-server
sudo systemctl start rabbitmq-server

# 启动应用服务
go run ./cmd/web &
go run ./cmd/admin &
go run ./cmd/seckill-worker &
```

### 2. 准备测试数据

确保至少有一个商品存在，建议：

```bash
# 通过Admin接口创建测试商品
curl -X POST http://localhost:8081/api/products \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试秒杀商品",
    "description": "用于测试的秒杀商品",
    "price": 10000,
    "stock": 100,
    "seckill_stock": 50,
    "category": "men",
    "status": 2,
    "start_time": "2024-01-01T00:00:00Z",
    "end_time": "2024-12-31T23:59:59Z"
  }'
```

## 测试输出示例

```
==========================================
    秒杀功能测试程序
==========================================

【准备阶段】注册/登录用户...
✅ 登录成功，Token: eyJhbGciOiJIUzI1NiIs...

==========================================
    开始功能测试
==========================================

测试: 1. 秒杀时间校验
✅ 1. 秒杀时间校验
   结果: 时间校验生效: seckill not started yet
   耗时: 123ms

测试: 2. 商品状态校验
✅ 2. 商品状态校验
   结果: 状态校验生效: product is not in seckill status
   耗时: 98ms

...

==========================================
    测试报告
==========================================

✅ 1. 秒杀时间校验
   结果: 时间校验生效: seckill not started yet
   耗时: 123ms

✅ 2. 商品状态校验
   结果: 状态校验生效: product is not in seckill status
   耗时: 98ms

...

==========================================
总计: 12 个测试
通过: 10 个
失败: 2 个
通过率: 83.3%
==========================================
```

## 手动测试指南

详细的手动测试步骤请参考：`cmd/test-seckill-features/manual_tests.md`

### 快速手动测试命令

#### 1. 测试库存自动同步

```bash
# 更新商品库存
curl -X PUT http://localhost:8081/api/products/1 \
  -H "Content-Type: application/json" \
  -d '{"seckill_stock": 80, "status": 2, ...}'

# 检查Redis
redis-cli GET "seckill:stock:1"
```

#### 2. 测试监控功能

```bash
curl http://localhost:8081/api/monitor/stats | jq
```

#### 3. 测试限流

```bash
# 快速发送多个请求
for i in {1..20}; do
  curl -X POST http://localhost:8080/api/seckill/1/$PATH \
    -H "Authorization: $TOKEN"
done
```

## 故障排查

### 问题1: 连接失败

**错误**: `dial tcp 127.0.0.1:8080: connect: connection refused`

**解决**: 
```bash
# 检查服务状态
sudo systemctl status goseckill-web
ps aux | grep "cmd/web"
```

### 问题2: 认证失败

**错误**: `登录失败: invalid password`

**解决**: 测试程序会自动注册用户，如果失败请检查数据库连接

### 问题3: 商品不存在

**错误**: `没有可用商品`

**解决**: 通过Admin接口创建测试商品

### 问题4: 限流未生效

**原因**: 限流配置可能较宽松

**解决**: 增加请求频率或调整限流参数

## 测试覆盖说明

### 完全自动化测试
- 时间校验
- 状态校验
- 订单查询
- 结果查询
- 实时库存
- 监控统计
- 限流功能

### 需要手动验证
- 库存自动同步（需要Admin权限）
- 消息确认机制（需要查看日志）
- Worker失败回滚（需要模拟失败）
- 库存一致性检查（需要运行同步服务）

## 扩展测试

可以扩展测试程序添加：

1. **并发测试**: 使用goroutine测试并发场景
2. **压力测试**: 测试系统负载能力
3. **集成测试**: 测试完整业务流程
4. **性能测试**: 测量响应时间和吞吐量

## 注意事项

1. **测试环境**: 建议在测试环境运行，避免影响生产数据
2. **数据清理**: 测试后可能需要清理测试数据
3. **服务依赖**: 确保所有依赖服务正常运行
4. **日志查看**: 某些测试需要查看服务日志

## 相关文档

- `cmd/test-seckill-features/README.md` - 详细测试说明
- `cmd/test-seckill-features/manual_tests.md` - 手动测试指南
- `功能完善总结.md` - 功能实现总结
