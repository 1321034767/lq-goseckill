# 修复活动结束后显示问题

## 问题描述

用户反馈：秒杀活动已经结束了，但商品详情页仍然显示：
- "秒杀库存: 2" 和 "(实时更新)" 字样
- "立即秒杀" 按钮仍然显示
- 活动相关信息仍然显示

## 根本原因

1. **秒杀库存API未检查活动状态**：`/api/products/{id}/seckill-stock` API 只返回库存数量，没有检查活动是否结束
2. **活动信息API未返回状态**：`/api/products/{id}/activity` API 在活动结束后返回 `null`，前端无法判断活动状态
3. **前端未根据活动状态隐藏元素**：前端没有根据活动状态动态显示/隐藏秒杀相关UI元素

## 解决方案

### 1. 修复秒杀库存API (`internal/server/router.go`)

**修改前**：
- 只返回库存数量，不检查活动状态

**修改后**：
- 先调用 `CheckAndUpdateExpiredActivities` 检查并更新过期活动
- 检查商品状态是否为秒杀状态（`Status == 2`）
- 检查活动是否还在进行中（时间范围和状态）
- 如果活动已结束或未开始，返回 `{"stock": 0, "is_active": false}`
- 如果活动进行中，返回实际库存和 `{"stock": X, "is_active": true}`

```go
api.Get("/products/{id:uint64}/seckill-stock", func(ctx iris.Context) {
    // 先检查并更新已过期的活动
    _ = activitySvc.CheckAndUpdateExpiredActivities(ctx.Request().Context())
    
    // 检查活动是否还在进行中
    // ... 检查逻辑 ...
    
    // 如果活动已结束，返回0
    if now.After(activity.EndTime) || now.Equal(activity.EndTime) || activity.Status != 1 {
        ctx.JSON(iris.Map{"code": 0, "data": iris.Map{"stock": 0, "is_active": false}})
        return
    }
    
    // 活动进行中，返回实际库存
    ctx.JSON(iris.Map{"code": 0, "data": iris.Map{"stock": stock, "is_active": true}})
})
```

### 2. 修复活动信息API (`internal/server/router.go`)

**修改前**：
- 活动结束后返回 `{"code": 0, "data": null}`

**修改后**：
- 活动结束后返回活动信息但标记 `"is_active": false`
- 活动进行中返回活动信息并标记 `"is_active": true`

```go
// 检查活动是否还在进行中
isActive := now.After(activity.StartTime) && now.Before(activity.EndTime) && activity.Status == 1
if isActive {
    ctx.JSON(iris.Map{
        "code": 0,
        "data": map[string]interface{}{
            // ... 活动信息 ...
            "is_active": true,
        },
    })
} else {
    // 活动已结束或未开始，返回活动信息但标记为不活跃
    ctx.JSON(iris.Map{
        "code": 0,
        "data": map[string]interface{}{
            // ... 活动信息 ...
            "is_active": false,
        },
    })
}
```

### 3. 修复前端商品详情页 (`web/views/product/view.html`)

#### 3.1 HTML结构调整

**修改前**：
- 秒杀库存和活动信息没有独立的容器

**修改后**：
- 为秒杀库存添加 `id="seckill-stock-container"` 容器
- 为活动信息添加 `id="activity-info-container"` 容器
- 为限购信息添加 `id="limit-per-user-container"` 和 `id="limit-per-user-container-gray"` 容器

```html
<span id="seckill-stock-container">
    <label style="margin-left:8px;">秒杀库存：</label>
    <span id="seckill-stock-count">{{.product.SeckillStock}}</span>
    <small class="text-muted" style="margin-left:8px;">（实时更新）</small>
</span>

<div id="activity-info-container" class="quantity" style="margin-top:5px;">
    <label style="color:#dc3545;font-weight:bold;">限时活动：</label>
    <span style="color:#dc3545;font-weight:bold;">{{.activity.name}}</span>
</div>
```

#### 3.2 JavaScript逻辑优化

**`updateSeckillStock()` 函数**：
- 检查 `res.data.is_active` 状态
- 如果活动未激活或库存为0，隐藏秒杀按钮和秒杀库存容器
- 如果活动进行中，显示秒杀按钮和库存

```javascript
function updateSeckillStock() {
    api("/api/products/" + productId + "/seckill-stock", { method: "GET" })
        .then(res => {
            const seckillBtn = document.getElementById("detail-seckill-btn");
            const seckillStockContainer = document.getElementById("seckill-stock-container");
            
            // 如果活动未激活或库存为0，隐藏秒杀相关元素
            if (!res.data.is_active || res.data.stock === undefined || res.data.stock <= 0) {
                if (seckillBtn) {
                    seckillBtn.style.display = "none";
                }
                if (seckillStockContainer) {
                    seckillStockContainer.style.display = "none";
                }
                return;
            }
            
            // 活动进行中，显示秒杀库存和按钮
            // ...
        });
}
```

**`updateActivityInfo()` 函数**：
- 检查 `res.data.is_active` 状态
- 如果活动未激活，隐藏红色活动信息，显示灰色限购信息
- 如果活动进行中，显示红色活动信息，隐藏灰色限购信息

```javascript
function updateActivityInfo() {
    api("/api/products/" + productId + "/activity", { method: "GET" })
        .then(res => {
            const activityInfoContainer = document.getElementById("activity-info-container");
            const limitPerUserContainer = document.getElementById("limit-per-user-container");
            const limitPerUserContainerGray = document.getElementById("limit-per-user-container-gray");
            
            // 如果活动未激活，隐藏活动相关元素
            if (!res || !res.data || !res.data.is_active) {
                if (activityInfoContainer) {
                    activityInfoContainer.style.display = "none";
                }
                if (limitPerUserContainer) {
                    limitPerUserContainer.style.display = "none";
                }
                if (limitPerUserContainerGray) {
                    limitPerUserContainerGray.style.display = "";
                }
                return;
            }
            
            // 活动进行中，显示活动信息
            // ...
        });
}
```

## 刷新频率

- **秒杀库存更新**：每3秒更新一次
- **活动信息更新**：每5秒更新一次

## 测试方法

1. **测试活动结束后显示**：
   - 创建一个秒杀活动，设置结束时间为当前时间之前
   - 打开商品详情页
   - 等待3-5秒，验证：
     - "秒杀库存" 和 "(实时更新)" 应该被隐藏
     - "立即秒杀" 按钮应该被隐藏
     - "限时活动" 和红色 "每人限购" 应该被隐藏
     - 灰色的 "每人限购: - 件" 应该显示

2. **测试活动进行中显示**：
   - 创建一个秒杀活动，设置开始和结束时间包含当前时间
   - 打开商品详情页
   - 验证：
     - "秒杀库存" 和 "(实时更新)" 应该显示
     - "立即秒杀" 按钮应该显示
     - "限时活动" 和红色 "每人限购" 应该显示
     - 灰色的 "每人限购" 应该隐藏

3. **测试实时更新**：
   - 在活动进行中打开商品详情页
   - 等待活动结束时间到达
   - 等待3-5秒，验证所有秒杀相关元素自动隐藏

## 修改的文件

1. ✅ `internal/server/router.go` - 修复秒杀库存API和活动信息API
2. ✅ `web/views/product/view.html` - 修复前端显示逻辑和HTML结构

## 总结

已修复活动结束后商品详情页仍然显示秒杀相关元素的问题：
- ✅ 秒杀库存API检查活动状态
- ✅ 活动信息API返回活动状态
- ✅ 前端根据活动状态动态显示/隐藏元素
- ✅ 实时更新机制确保活动结束后自动隐藏

现在，当秒杀活动结束后，商品详情页会自动隐藏所有秒杀相关的UI元素！
