# 修复活动状态不更新问题

## 问题描述

秒杀活动已经结束了，但是：
1. 活动列表显示"进行中"
2. 商品列表显示"秒杀中"

## 问题原因

1. **后台管理API缺少过期检查**：
   - `GET /api/products` (商品列表) - 没有调用 `CheckAndUpdateExpiredActivities`
   - `GET /api/seckill-activities` (活动列表) - 没有调用 `CheckAndUpdateExpiredActivities`
   - `GET /api/seckill-activities/{id}` (活动详情) - 没有调用 `CheckAndUpdateExpiredActivities`

2. **过期检查逻辑不够完善**：
   - 原逻辑只检查 `activity.Status == 1`（进行中）的活动
   - 如果活动状态不是1，即使已过期也不会更新

## 解决方案

### 1. 在后台管理API中添加过期检查

**文件**: `internal/server/admin_router.go`

- 在 `GET /api/products` 中添加过期检查
- 在 `GET /api/seckill-activities` 中添加过期检查
- 在 `GET /api/seckill-activities/{id}` 中添加过期检查

```go
// 检查并更新已过期的活动（恢复商品状态）
_ = activitySvc.CheckAndUpdateExpiredActivities(ctx.Request().Context())
```

### 2. 改进过期检查逻辑

**文件**: `internal/service/seckill_activity_service.go`

**改进前**：
```go
// 只检查状态为1（进行中）的活动
if activity.Status == 1 && now.After(activity.EndTime) {
    // ...
}
```

**改进后**：
```go
// 检查所有已过期的活动，无论当前状态如何
if now.After(activity.EndTime) && activity.Status != 2 {
    // 更新活动状态为已结束
    activity.Status = 2
    // 恢复商品状态
    // ...
}
```

## 修改的文件

1. `internal/server/admin_router.go` - 在3个API中添加过期检查
2. `internal/service/seckill_activity_service.go` - 改进过期检查逻辑

## 测试方法

1. **创建并启动一个秒杀活动**，设置结束时间为未来几分钟
2. **等待活动结束**
3. **刷新后台管理页面**：
   - 活动列表应该显示"已结束"
   - 商品列表应该显示"正常"状态
   - 商品的秒杀库存应该为0

## 工作原理

1. **自动检查**：每次访问后台管理的商品列表、活动列表或活动详情时，都会自动检查并更新已过期的活动
2. **状态更新**：
   - 活动状态：`进行中(1)` → `已结束(2)`
   - 商品状态：`秒杀中(2)` → `正常(1)`
   - 秒杀库存：清零
3. **实时性**：刷新页面即可看到最新状态，无需手动操作

## 注意事项

- 过期检查是**被动触发**的，只有在访问相关API时才会执行
- 如果需要**定时自动检查**，可以考虑添加一个后台定时任务
- 前台页面（`router.go`）已经包含了过期检查，所以前台显示是正确的
