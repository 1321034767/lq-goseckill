# 活动关联商品功能实现说明

## 问题描述

用户反馈：
1. 前台商品中没有显示限时活动信息
2. 商品不随限时活动结束而消失，只是秒杀库存清零
3. 需要显示活动的限购数量等信息

## 解决方案

### 1. 添加活动信息查询功能

**新增服务方法** (`internal/service/seckill_activity_service.go`):
- `GetActivityByProduct()`: 根据商品ID获取该商品所属的活动信息
- `CheckAndUpdateExpiredActivities()`: 检查并更新已过期的活动，自动恢复商品状态

### 2. 修改商品列表API

**修改** (`internal/server/router.go`):
- 商品列表API (`/api/products`) 现在会：
  - 自动检查并更新已过期的活动
  - 为每个处于秒杀状态的商品查询并返回活动信息（限购数量、活动时间等）
  - 如果活动已结束，自动恢复商品状态为"正常"，清零秒杀库存

**返回格式示例**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "商品名称",
      "status": 2,
      "activity": {
        "id": 1,
        "name": "限时秒杀活动",
        "discount": 0.8,
        "limit_per_user": 2,
        "start_time": "2024-01-01T10:00:00Z",
        "end_time": "2024-01-01T12:00:00Z"
      }
    }
  ]
}
```

### 3. 添加商品活动信息API

**新增API** (`/api/products/{id}/activity`):
- 获取指定商品的活动信息
- 自动检查活动是否过期
- 如果活动已结束，自动恢复商品状态

### 4. 修改商品详情页

**后端修改** (`internal/server/router.go`):
- 商品详情页 (`/product/{id}`) 现在会：
  - 自动检查并更新已过期的活动
  - 查询商品的活动信息
  - 将活动信息传递给前端模板

**前端修改** (`web/views/product/view.html`):
- 显示活动名称
- 显示限购数量（从活动信息中获取）
- 通过API实时更新活动信息

### 5. 活动结束自动处理

**自动处理逻辑**:
1. 每次查询商品列表或详情时，都会调用 `CheckAndUpdateExpiredActivities()`
2. 检查所有活动，如果活动已结束但状态还是"进行中"：
   - 更新活动状态为"已结束"
   - 恢复该活动下所有商品的状态为"正常"（Status=1）
   - 清零商品的秒杀库存（SeckillStock=0）

## 修改的文件

1. **服务层**
   - `internal/service/seckill_activity_service.go` - 添加活动查询和过期检查方法

2. **路由层**
   - `internal/server/router.go` - 修改商品列表和详情API，添加活动信息查询

3. **前端**
   - `web/views/product/view.html` - 显示活动信息和限购数量

## 功能特点

1. **自动恢复商品状态**: 活动结束时，商品自动从"秒杀中"恢复为"正常"状态
2. **实时活动信息**: 商品列表和详情页都会显示当前活动的限购数量等信息
3. **库存自动清零**: 活动结束后，秒杀库存自动清零
4. **无需手动操作**: 所有处理都是自动的，无需管理员手动操作

## 测试方法

1. **创建活动**:
   - 在后台创建秒杀活动，设置限购数量为2
   - 启动活动

2. **查看商品列表**:
   - 访问 `http://localhost:8080`
   - 查看商品列表，确认活动信息显示正确

3. **查看商品详情**:
   - 点击商品进入详情页
   - 确认限购数量显示正确

4. **测试活动结束**:
   - 等待活动结束时间到达
   - 刷新商品列表或详情页
   - 确认商品状态自动恢复为"正常"，秒杀库存清零
   - 确认活动信息不再显示

## 注意事项

1. **性能考虑**: 每次查询商品列表时都会检查所有活动，如果活动数量很大，可能需要优化
2. **定时任务**: 目前是在每次查询时检查，可以考虑添加定时任务定期检查
3. **Redis库存**: 活动结束后，Redis中的秒杀库存不会自动清理，需要手动清理或等待过期

## 后续优化建议

1. 添加定时任务定期检查过期活动
2. 活动结束时清理Redis中的秒杀库存
3. 添加活动结束通知功能
4. 优化活动查询性能（缓存、索引等）
