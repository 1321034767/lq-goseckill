# 服务无法访问问题排查指南

## 快速检查步骤

### 1. 检查服务是否正在运行

```bash
# 检查端口是否被监听
netstat -tlnp | grep 8080
# 或
ss -tlnp | grep 8080

# 检查进程是否运行
ps aux | grep "go run\|goseckill\|cmd/web\|cmd/admin"
```

### 2. 检查服务启动日志

服务启动时应该看到类似输出：
```
web server listening on 0.0.0.0:8080
```

如果没有看到这个输出，说明服务启动失败。

### 3. 检查依赖服务是否正常

```bash
# 检查 MySQL
sudo systemctl status mysql
# 或
sudo systemctl status mysqld
mysql -u goseckill -pgoseckill123 -h 127.0.0.1 -e "SELECT 1"

# 检查 Redis
sudo systemctl status redis-server
# 或
sudo systemctl status redis
redis-cli ping  # 应该返回 PONG

# 检查 RabbitMQ
sudo systemctl status rabbitmq-server
sudo rabbitmqctl status
```

### 4. 检查防火墙

```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 8080/tcp
sudo ufw allow 8081/tcp

# CentOS/RHEL
sudo firewall-cmd --list-ports
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --permanent --add-port=8081/tcp
sudo firewall-cmd --reload

# 检查 iptables
sudo iptables -L -n | grep 8080
```

### 5. 检查云服务器安全组

如果是云服务器，需要在控制台配置安全组规则：
- 开放 8080 端口（Web 服务）
- 开放 8081 端口（Admin 服务）

### 6. 本地测试服务

```bash
# 在服务器上测试（应该能访问）
curl http://localhost:8080/api/health
curl http://127.0.0.1:8080/api/health

# 如果本地可以访问，说明服务正常，问题在防火墙或安全组
```

## 常见问题及解决方案

### 问题1：服务启动失败（数据库连接失败）

**错误信息：**
```
failed to run web server: dial tcp 127.0.0.1:3306: connect: connection refused
```

**解决方案：**
```bash
# 启动 MySQL
sudo systemctl start mysql
# 或
sudo systemctl start mysqld

# 检查 MySQL 是否监听
sudo netstat -tlnp | grep 3306

# 创建数据库（如果还没创建）
sudo mysql -u root -p << EOF
CREATE DATABASE IF NOT EXISTS goseckill CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'goseckill'@'localhost' IDENTIFIED BY 'goseckill123';
GRANT ALL PRIVILEGES ON goseckill.* TO 'goseckill'@'localhost';
FLUSH PRIVILEGES;
EOF
```

### 问题2：Redis 连接失败

**解决方案：**
```bash
sudo systemctl start redis-server
# 或
sudo systemctl start redis

# 测试连接
redis-cli ping
```

### 问题3：RabbitMQ 连接失败

**解决方案：**
```bash
sudo systemctl start rabbitmq-server
sudo rabbitmqctl status
```

### 问题4：端口被占用

**检查：**
```bash
sudo lsof -i :8080
sudo netstat -tlnp | grep 8080
```

**解决：**
```bash
# 找到占用端口的进程并杀死
sudo kill -9 <PID>
```

### 问题5：服务在前台运行，关闭终端后服务停止

**解决方案：使用后台运行或 screen/tmux**

```bash
# 方式1：后台运行
nohup go run ./cmd/web > web.log 2>&1 &
nohup go run ./cmd/admin > admin.log 2>&1 &

# 方式2：使用 screen
screen -S goseckill-web
go run ./cmd/web
# 按 Ctrl+A 然后 D 退出（服务继续运行）

screen -S goseckill-admin
go run ./cmd/admin
# 按 Ctrl+A 然后 D 退出

# 重新连接
screen -r goseckill-web

# 方式3：使用 tmux
tmux new -s goseckill-web
go run ./cmd/web
# 按 Ctrl+B 然后 D 退出

tmux attach -t goseckill-web
```

## 正确的启动方式

### 方式1：后台运行（推荐用于测试）

```bash
# 1. 启动依赖服务
sudo systemctl start mysql
sudo systemctl start redis-server
sudo systemctl start rabbitmq-server

# 2. 进入项目目录
cd /root/internship-preparation/goseckill-12-01

# 3. 后台启动服务
nohup go run ./cmd/web > web.log 2>&1 &
nohup go run ./cmd/admin > admin.log 2>&1 &

# 4. 查看日志
tail -f web.log
tail -f admin.log

# 5. 检查服务状态
ps aux | grep "go run"
netstat -tlnp | grep 8080
```

### 方式2：使用 screen（推荐）

```bash
# 1. 启动依赖服务
sudo systemctl start mysql redis-server rabbitmq-server

# 2. 启动 Web 服务（在 screen 中）
screen -dmS goseckill-web bash -c "cd /root/internship-preparation/goseckill-12-01 && go run ./cmd/web"

# 3. 启动 Admin 服务（在 screen 中）
screen -dmS goseckill-admin bash -c "cd /root/internship-preparation/goseckill-12-01 && go run ./cmd/admin"

# 4. 查看服务
screen -ls
screen -r goseckill-web  # 查看 Web 服务日志
screen -r goseckill-admin  # 查看 Admin 服务日志
```

### 方式3：编译后运行（推荐用于生产环境）

```bash
# 1. 编译
cd /root/internship-preparation/goseckill-12-01
go build -o bin/web ./cmd/web
go build -o bin/admin ./cmd/admin

# 2. 后台运行
nohup ./bin/web > web.log 2>&1 &
nohup ./bin/admin > admin.log 2>&1 &

# 3. 检查
ps aux | grep bin/web
netstat -tlnp | grep 8080
```

## 完整排查脚本

创建一个排查脚本：

```bash
#!/bin/bash
echo "=== 检查服务状态 ==="
echo "1. 检查端口监听："
netstat -tlnp | grep -E "8080|8081" || echo "  端口未监听"

echo "2. 检查进程："
ps aux | grep -E "go run|cmd/web|cmd/admin" | grep -v grep || echo "  进程未运行"

echo "3. 检查 MySQL："
sudo systemctl status mysql --no-pager | head -3 || sudo systemctl status mysqld --no-pager | head -3

echo "4. 检查 Redis："
sudo systemctl status redis-server --no-pager | head -3 || sudo systemctl status redis --no-pager | head -3

echo "5. 检查 RabbitMQ："
sudo systemctl status rabbitmq-server --no-pager | head -3

echo "6. 测试本地连接："
curl -s http://localhost:8080/api/health || echo "  本地无法访问"
```

## 访问地址

- **Web 前端**: `http://服务器IP:8080`
- **Admin 后台**: `http://服务器IP:8081`
- **健康检查**: `http://服务器IP:8080/api/health`

## 如果还是无法访问

1. **确认服务真的在运行**：`ps aux | grep "go run"`
2. **确认端口真的在监听**：`netstat -tlnp | grep 8080`
3. **确认本地可以访问**：`curl http://localhost:8080/api/health`
4. **检查防火墙**：`sudo ufw status` 或 `sudo firewall-cmd --list-ports`
5. **检查云服务器安全组**：在控制台配置开放 8080 和 8081 端口
