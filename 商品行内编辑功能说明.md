# 商品行内编辑功能说明

## 功能概述

在商品列表中实现了**行内编辑**功能，管理员可以直接在表格中编辑商品的价格、库存、秒杀库存、状态等字段，无需跳转到表单页面。

## 功能特点

### 1. **行内编辑模式**
- 点击"编辑"按钮后，该行变为编辑模式
- 可编辑字段变为输入框或下拉选择框
- 编辑行会高亮显示（黄色背景）

### 2. **可编辑字段**
- ✅ **名称** - 文本输入框
- ✅ **价格** - 数字输入框（元，支持小数）
- ✅ **库存** - 数字输入框（整数）
- ✅ **秒杀库存** - 数字输入框（整数）
- ✅ **状态** - 下拉选择框（下线/正常/秒杀中）

### 3. **操作按钮**
- **保存** - 保存修改并更新到服务器
- **取消** - 取消编辑，恢复原始数据

### 4. **用户体验优化**
- 编辑时行高亮显示，易于识别
- 保存时显示"保存中..."状态
- 保存成功后自动刷新列表
- 数据验证，防止无效数据提交
- 错误提示，友好的错误信息

## 使用方法

### 1. 开始编辑
1. 在商品列表中找到要编辑的商品
2. 点击该行的"编辑"按钮
3. 该行变为编辑模式，显示输入框

### 2. 修改数据
- 直接在输入框中修改价格、库存等
- 使用下拉框选择状态

### 3. 保存或取消
- 点击"保存"按钮保存修改
- 点击"取消"按钮放弃修改

## 技术实现

### 1. 前端实现

**文件**: `web/admin/assets/app.js`

#### 1.1 状态管理
```javascript
const state = {
  editingProductId: null, // 当前正在编辑的商品ID
  // ...
};
```

#### 1.2 渲染函数
- `renderProducts()` - 根据是否在编辑模式渲染不同的HTML
- 编辑模式：显示输入框和下拉框
- 显示模式：显示文本和编辑按钮

#### 1.3 事件处理
- `bindInlineEditEvents()` - 绑定行内编辑相关事件
- `startInlineEdit()` - 开始编辑
- `cancelInlineEdit()` - 取消编辑
- `saveInlineEdit()` - 保存编辑

#### 1.4 数据验证
- 名称不能为空
- 价格必须 >= 0
- 库存必须 >= 0
- 秒杀库存必须 >= 0

### 2. 后端API

**文件**: `internal/server/admin_router.go`

使用现有的 `PUT /api/products/{id}` 接口：
- 接收商品更新数据
- 验证数据有效性
- 更新数据库
- 如果商品是秒杀状态，同步库存到Redis

## 数据格式

### 请求格式
```json
{
  "name": "商品名称",
  "price": 990,  // 单位：分
  "stock": 100,
  "seckill_stock": 10,
  "status": 1,  // 0-下线, 1-正常, 2-秒杀中
  "description": "商品描述",
  "category": "men",
  "start_time": "2025-12-01 10:00:00",
  "end_time": "2025-12-01 20:00:00"
}
```

### 响应格式
```json
{
  "code": 0,
  "data": {
    "ID": 1,
    "Name": "商品名称",
    "Price": 990,
    "Stock": 100,
    "SeckillStock": 10,
    "Status": 1,
    // ...
  }
}
```

## 安全特性

### 1. XSS防护
- 使用 `escapeHtml()` 函数转义HTML，防止XSS攻击

### 2. 数据验证
- 前端验证：防止无效数据提交
- 后端验证：确保数据完整性

### 3. 错误处理
- 友好的错误提示
- 保存失败时恢复按钮状态

## 注意事项

1. **同时只能编辑一个商品**
   - 如果正在编辑一个商品，点击另一个商品的编辑按钮会先取消当前编辑

2. **时间字段不可编辑**
   - 开始时间和结束时间在当前版本中不可编辑
   - 如需修改时间，请使用表单编辑功能

3. **秒杀库存限制**
   - 秒杀库存不能超过总库存
   - 后端会验证此限制

4. **状态变更影响**
   - 如果商品状态改为"秒杀中"，系统会自动同步库存到Redis
   - 如果商品状态改为其他状态，秒杀库存会被保留

## 测试方法

1. **启动admin服务**：
   ```bash
   go run ./cmd/admin
   ```

2. **访问后台管理页面**：
   - 打开 `http://localhost:8081`
   - 进入"商品列表"页面

3. **测试编辑功能**：
   - 点击任意商品的"编辑"按钮
   - 修改价格、库存、状态等字段
   - 点击"保存"验证是否成功
   - 点击"取消"验证是否恢复原始数据

4. **测试数据验证**：
   - 尝试输入负数价格
   - 尝试输入空名称
   - 验证错误提示是否正常显示

## 修改的文件

1. ✅ `web/admin/assets/app.js` - 添加行内编辑功能

## 未来改进

1. **支持时间字段编辑** - 添加日期时间选择器
2. **批量编辑** - 支持同时编辑多个商品
3. **撤销功能** - 支持撤销最近一次修改
4. **快捷键支持** - 支持Ctrl+S保存，Esc取消

## 总结

商品行内编辑功能已成功实现，管理员可以方便快捷地修改商品信息，提高了管理效率。功能稳定可靠，具有良好的用户体验。
