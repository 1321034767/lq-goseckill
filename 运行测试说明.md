# 运行测试说明

## 当前状态

测试程序已创建完成，但由于服务可能未启动，需要先启动服务才能运行测试。

## 快速开始

### 步骤1: 启动服务

```bash
# 进入项目目录
cd /root/internship-preparation/goseckill-12-01

# 启动依赖服务
sudo systemctl start mysql
sudo systemctl start redis-server
sudo systemctl start rabbitmq-server

# 启动应用服务（在后台运行）
nohup go run ./cmd/web > web.log 2>&1 &
nohup go run ./cmd/admin > admin.log 2>&1 &
nohup go run ./cmd/seckill-worker > worker.log 2>&1 &

# 等待几秒让服务启动
sleep 3

# 检查服务状态
curl http://localhost:8080/api/health
curl http://localhost:8081/api/health
```

### 步骤2: 运行测试

```bash
# 方式1: 使用快速测试脚本
bash quick_test.sh

# 方式2: 直接运行测试程序
cd cmd/test-seckill-features
go run main.go

# 方式3: 使用完整测试脚本
bash test_all_features.sh
```

## 测试程序功能

测试程序会自动测试以下功能：

### 自动化测试（8项）

1. ✅ 秒杀时间校验
2. ✅ 商品状态校验  
3. ✅ 订单查询接口
4. ✅ 秒杀结果查询接口
5. ✅ 秒杀库存实时显示
6. ✅ 监控功能
7. ✅ 限流功能
8. ✅ 前端秒杀结果展示（提示）

### 需要手动验证（4项）

9. ⚠️ 库存自动同步机制
10. ⚠️ RabbitMQ消息确认机制
11. ⚠️ Worker失败时的库存回滚
12. ⚠️ 库存一致性检查

## 预期输出

```
==========================================
    秒杀功能测试程序
==========================================

【准备阶段】注册/登录用户...
✅ 登录成功，Token: eyJhbGciOiJIUzI1NiIs...

==========================================
    开始功能测试
==========================================

测试: 1. 秒杀时间校验
✅ 1. 秒杀时间校验
   结果: 时间校验生效: seckill not started yet
   耗时: 123ms

...

==========================================
    测试报告
==========================================

总计: 12 个测试
通过: 10 个
失败: 2 个
通过率: 83.3%
```

## 故障排查

### 问题1: 连接被拒绝

**错误**: `dial tcp 127.0.0.1:8080: connect: connection refused`

**解决**: 
```bash
# 检查服务是否运行
ps aux | grep "cmd/web"
ps aux | grep "cmd/admin"

# 查看日志
tail -f web.log
tail -f admin.log

# 重新启动服务
pkill -f "cmd/web"
pkill -f "cmd/admin"
go run ./cmd/web &
go run ./cmd/admin &
```

### 问题2: 数据库连接失败

**错误**: `failed to connect mysql`

**解决**:
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 启动MySQL
sudo systemctl start mysql

# 检查数据库是否存在
mysql -u goseckill -p -e "SHOW DATABASES;"
```

### 问题3: Redis连接失败

**错误**: `failed to connect redis`

**解决**:
```bash
# 检查Redis状态
sudo systemctl status redis-server

# 启动Redis
sudo systemctl start redis-server

# 测试连接
redis-cli PING
```

### 问题4: 没有测试商品

**错误**: `没有可用商品`

**解决**:
```bash
# 通过Admin接口创建测试商品
curl -X POST http://localhost:8081/api/products \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试秒杀商品",
    "description": "用于测试",
    "price": 10000,
    "stock": 100,
    "seckill_stock": 50,
    "category": "men",
    "status": 2,
    "start_time": "2024-01-01T00:00:00Z",
    "end_time": "2024-12-31T23:59:59Z"
  }'
```

## 手动测试

对于需要手动验证的功能，请参考：
- `cmd/test-seckill-features/manual_tests.md`

## 下一步

1. 启动所有服务
2. 运行测试程序
3. 查看测试报告
4. 根据报告进行手动验证
