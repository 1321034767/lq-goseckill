<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户中心</title>
    <style>
        :root {
            --bg: #030712;
            --panel: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #38bdf8;
            --accent-2: #a855f7;
            --danger: #f87171;
            --success: #34d399;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 48px 18px;
            min-height: 100vh;
            color: var(--text);
            background: radial-gradient(circle at top, #0b1224 0, #050816 50%, #01030a 100%);
        }
        .panel {
            max-width: 960px;
            margin: 0 auto;
            background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
            padding: 32px;
            backdrop-filter: blur(10px);
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 26px;
            letter-spacing: 0.3px;
        }
        p {
            color: var(--muted);
            margin: 0 0 12px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            background: var(--panel);
        }
        .card h3 {
            margin: 0 0 8px 0;
            font-size: 15px;
            color: var(--muted);
            letter-spacing: 0.2px;
        }
        .balance {
            font-size: 28px;
            font-weight: 700;
            color: var(--success);
        }
        .secondary {
            color: var(--muted);
            font-size: 13px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            color: var(--text);
        }
        th, td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            text-align: left;
        }
        th {
            color: var(--muted);
            font-weight: 600;
        }
        .amount-pos { color: var(--success); }
        .amount-neg { color: var(--danger); }
        .actions {
            margin-top: 28px;
        }
        .actions a,
        .actions button {
            display: inline-block;
            margin-right: 12px;
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 14px;
            background: var(--panel);
            color: var(--text);
            text-decoration: none;
            transition: all .15s ease;
        }
        .actions a:hover,
        .actions button:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 10px 25px rgba(56,189,248,0.18);
        }
        .actions button {
            border-color: rgba(248,113,113,0.5);
            color: var(--danger);
        }
        .actions button:hover {
            box-shadow: 0 10px 25px rgba(248,113,113,0.18);
        }
    </style>
</head>
<body>
<div class="panel">
    <h1>用户中心</h1>
    <p>账户概览与交易流水。</p>

    <div class="grid">
        <div class="card">
            <h3>账户余额</h3>
            <div class="balance" id="balance">¥ --</div>
            <div class="secondary" id="balance-desc">可用于下单/秒杀扣款</div>
        </div>
        <div class="card">
            <h3>冻结金额</h3>
            <div class="balance" id="frozen" style="color:#f97316;">¥ --</div>
            <div class="secondary">进行中的订单/秒杀占用</div>
        </div>
        <div class="card">
            <h3>最近更新</h3>
            <div style="font-size:14px;" id="updated-at">--</div>
            <div class="secondary">以最新交易时间为准</div>
        </div>
    </div>

    <div class="card" style="margin-top:20px;">
        <h3>交易记录</h3>
        <table>
            <thead>
                <tr>
                    <th>时间</th>
                    <th>类型</th>
                    <th>金额</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody id="tx-body">
            </tbody>
        </table>
        <div class="secondary">更多记录可分页加载或导出明细。</div>
    </div>

    <div class="actions">
        <a href="/">返回首页</a>
        <button onclick="window.location.href='/user/logout'">退出登录</button>
    </div>
</div>

<script>
    function getCookie(name) {
        const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
        if (match) return decodeURIComponent(match[2]);
        return "";
    }
    function fmtMoney(cents) {
        if (typeof cents !== "number") return "--";
        return (cents / 100).toFixed(2);
    }
    const token = getCookie("token");
    const balanceEl = document.getElementById("balance");
    const frozenEl = document.getElementById("frozen");
    const updatedEl = document.getElementById("updated-at");
    const txBody = document.getElementById("tx-body");
    const balanceDesc = document.getElementById("balance-desc");

    if (!token) {
        balanceDesc.textContent = "请先登录后查看账户信息";
        if (txBody) {
            txBody.innerHTML = "<tr><td colspan='4' style='color:#f87171;'>未登录，无法加载交易记录。</td></tr>";
        }
    } else {
        fetch("/api/user/account", { headers: { Authorization: token } })
            .then(r => r.json())
            .then(res => {
                if (!res || res.code !== 0) throw new Error(res && res.msg ? res.msg : "加载失败");
                const d = res.data || {};
                balanceEl.textContent = "¥ " + fmtMoney(d.balance);
                frozenEl.textContent = "¥ " + fmtMoney(d.frozen);
                updatedEl.textContent = d.updated_at || "--";
            })
            .catch(e => {
                balanceDesc.textContent = "账户信息加载失败：" + e;
            });

        fetch("/api/user/transactions", { headers: { Authorization: token } })
            .then(r => r.json())
            .then(res => {
                if (!res || res.code !== 0) throw new Error(res && res.msg ? res.msg : "加载失败");
                const list = res.data || [];
                if (list.length === 0) {
                    txBody.innerHTML = "<tr><td colspan='4' class='secondary'>暂无交易记录</td></tr>";
                    return;
                }
                txBody.innerHTML = "";
                list.forEach(item => {
                    const tr = document.createElement("tr");
                    const cls = item.amount >= 0 ? "amount-pos" : "amount-neg";
                    const sign = item.amount >= 0 ? "+ " : "- ";
                    tr.innerHTML = [
                        "<td>" + (item.time || "--") + "</td>",
                        "<td>" + (item.type || "--") + "</td>",
                        "<td class='" + cls + "'>" + sign + "¥ " + fmtMoney(Math.abs(item.amount || 0)) + "</td>",
                        "<td>" + (item.status || "--") + "</td>",
                    ].join("");
                    txBody.appendChild(tr);
                });
            })
            .catch(e => {
                txBody.innerHTML = "<tr><td colspan='4' style='color:#f87171;'>交易记录加载失败：" + e + "</td></tr>";
            });
    }
</script>
</body>
</html>
